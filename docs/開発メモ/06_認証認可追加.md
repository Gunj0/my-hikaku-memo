# 認証認可追加

## 方針

- [Better Auth](https://www.better-auth.com/)を使用する
  - NextAuth.js / Auth.js は Better Auth に統合された
  - https://www.better-auth.com/blog/authjs-joins-better-auth

## Better Auth インストール

[Installation](https://www.better-auth.com/docs/installation)

```zsh
% pnpm add better-auth
```

## 環境変数追加

```.env
BETTER_AUTH_SECRET={`openssl rand -base64 32` で生成}
BETTER_AUTH_URL=http://localhost:3000
```

## src/lib/auth.ts 追加

```ts
import { betterAuth } from "better-auth";
import { jwt } from "better-auth/plugins";

export const auth = betterAuth({
  baseURL: process.env.BETTER_AUTH_URL, // リダイレクトURL作成時に必要
  socialProviders: {
    google: {
      clientId: process.env.GOOGLE_CLIENT_ID as string,
      clientSecret: process.env.GOOGLE_CLIENT_SECRET as string,
    },
  },
  // JWTトークン発行, JWKS公開鍵エンドポイントを追加
  // https://www.better-auth.com/docs/plugins/jwt
  plugins: [
    jwt({
      jwks: {
        // デフォルトの暗号方式EdDSAはASP.NETで対応していないためRS256に変更
        keyPairConfig: { alg: "RS256" },
      },
    }),
  ],
});
```

## src/app/api/auth/[...all]/route.ts 追加

```ts
import { auth } from "@/lib/auth";
import { toNextJsHandler } from "better-auth/next-js";

// ルートハンドラー
export const { POST, GET } = toNextJsHandler(auth);
```

## src/lib/auth-client.ts 追加

```ts
import { jwtClient } from "better-auth/client/plugins";
import { createAuthClient } from "better-auth/react";

// クライアント側で使用するメソッド
export const authClient = createAuthClient({
  // JWT対応
  // https://www.better-auth.com/docs/plugins/jwt
  plugins: [jwtClient()],
});
```

- http://localhost:3000/api/auth/token でトークンが取得可能になる

## ログインボタン追加

```tsx
const login = async () => {
  await authClient.signIn.social({
    provider: "google",
  });
};
// ログインボタン
return <Button onClick={login}>Googleでログイン</Button>;
```

## ログアウトボタン追加

```tsx
const logOut = async () => {
  await authClient.signOut();
};
// ログアウトボタン
return <Button onClick={logOut}>ログアウト</Button>;
```

## セッションの取得

```tsx
const session = authClient.useSession();
return (
  <>
    {!session?.data?.session ? (
      // セッションがない場合
      <SignIn />
    ) : (
      // セッションがある場合
      <SignOut />
    )}
  </>
);
```

## 動作確認

- アプリから、テストアカウントでログインできることを確認する
